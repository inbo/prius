# Inleiding

Eigen poging om verspreidingskaartjes op te maken voor de PrIUS-soorten. Deze verloopt niet via de cube.

# Bibliotheken

```{r}
library(rgdal) # check
library(sp) # check
library(leaflet) # check
library(tidyverse) # check
library(rgbif) # confirmed
library(ows4R) # confirmed
library(httr) # confirmed
```

# Hoofd leegmaken

```{r}
rm(list = ls())
```

# GBIF login-gegevens

Gezien dit een gedeeld bestand is, worden de login-gegevens niet uitgetypt (e-mail, gebruikersnaam en paswoord) maar via een invulveld opgevraagd.

```{r}
get_cred <- function(x){
  library(svDialogs)
    cred <- Sys.getenv(x)
    if(cred == ""){
    input <- dlgInput(paste0("What is your ", x, "?"))
    cred <- input$res
    Sys.setenv(x = cred)
  }
  return(cred)
}
gbif_email <- get_cred("GBIF e-mail")
gbif_user <- get_cred("GBIF username")
gbif_pwd <- get_cred("GBIF password")
```

# Get species list

```{r get species list}
species_list <- read_csv2("./data/input/prius_species_list_v22-06-01.csv")
```

# Get shapes

```{r}
vla_1km <- readOGR("./data/spatial/grids/vla_1km.geojson") # Nog nodig ?
vla_10km <- readOGR("./data/spatial/grids/vla_10km.geojson") # Nog nodig ?
```

# Get GBIF data

De 'GBIF taxon ID' vind je o.a. onder de 'Taxon Identifiers' onderaan de (soorts)pagina.

```{r}
taxonKey <- species_list$gbifapi_acceptedKey[1]

if(dir.exists("./data/distribution/")){
  filelist <- dir("./data/distribution", 
                  pattern = ".zip", 
                  full.names = TRUE)
  filelist_info <- file.info(filelist)
  filelist_info <- filelist_info %>% 
    filter(ctime == max(ctime, na.rm = TRUE)) 
  
  if(nrow(filelist_info) == 1){
    old_data <- rownames(filelist_info)
  }else{
    warning("Multiple zip-files are the same age. downloading new data")
    old_data <- ""
  }
}else{
  old_data <- ""
}
```

```{r}
rerun <- menu(choices = c("Yes", "No"), 
              title = "Download new data?",
              graphics = TRUE)

if(old_data == "" || rerun == 1){
  set1 <- occ_download(pred_in("taxonKey", c(3129663, 2882443, 2437394, 2482499, 2765940)), 
                       pred("hasCoordinate", TRUE), 
                       pred("country", "BE"), 
                       pred_gte("year", 2015), # JAAR = 2015
                       user = gbif_user, 
                       pwd = gbif_pwd, 
                       email = gbif_email)
  
  repeat{
    Sys.sleep(time = 5)
    test_set1 <- occ_download_meta(set1)
    if(test_set1$status == "SUCCEEDED"){
      rawdata_set1_imported <- occ_download_get(set1, overwrite = TRUE) %>% 
        occ_download_import()
      break()
    }
    print(test_set1$status)
  }
  
  file.copy(from = paste0("./", test_set1$key, ".zip"), 
            to = paste0("./data/distribution/",
                        test_set1$key, ".zip"))
  file.remove(paste0("./", test_set1$key, ".zip"))
  
}else{
  rawdata_set1_imported <- read_tsv(unz(old_data,
                                        "occurrence.txt"), 
                                    col_types = c(decimalLatitude = col_number(),
                                                  decimalLongitude = col_number()))
}
```

# Subset: filter and mutate

These filters are applied:
1: Filter records with the same occurenceID => most straightforward way to get rid of duplicates
2: Filter records without coordinates (assuming decimalLatitude & decimalLongitude are equally missing)

```{r}
data_subset <- rawdata_set1_imported %>% 
  distinct(occurrenceID, .keep_all = TRUE) %>% #1
  filter(!is.na(decimalLatitude)) %>% #2 
  select(gbifID, eventDate, year, month, day, taxonKey, acceptedTaxonKey, 
                species, decimalLatitude, decimalLongitude, coordinateUncertaintyInMeters,
                countryCode)
```

# Make data spatial

```{r}
coord <- data_subset %>% 
  select(decimalLongitude, decimalLatitude)

crs_wgs <- CRS("+proj=longlat +datum=WGS84 +no_defs ") # CRS = coordinate reference system

data_sp <- SpatialPointsDataFrame(coord,
                                  data = data_subset,
                                  proj4string = crs_wgs)
```

# Vlaanderen

```{r}
wfs_regions <- "https://eservices.minfin.fgov.be/arcgis/services/R2C/Regions/MapServer/WFSServer"
regions_client <- WFSClient$new(wfs_regions, 
                                serviceVersion = "2.0.0")
regions_client$getFeatureTypes(pretty = TRUE)
url <- parse_url(wfs_regions)
url$query <- list(service = "wfs",
                  version = "2.0.0", # optional
                  request = "GetFeature",
                  typename = "regions",
                  srsName = "EPSG:3857"
)
request <- build_url(url)
bel_regions <- readOGR(request, stringsAsFactors = FALSE) # Kan effe duren...
flanders <- subset(bel_regions, bel_regions$NameDUT == "Vlaams Gewest")
flanders <- spTransform(flanders, crs_wgs)
bbox <- as.data.frame(flanders@bbox)
```

```{r test flanders, eval=FALSE}
leaflet(flanders) %>% 
  addTiles() %>% 
  addPolylines() 
```